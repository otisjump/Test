<script>
const codeArea = document.getElementById("code");
const preview = document.getElementById("preview");
const panel = document.getElementById("controlPanel");

let originalCode = '';
let whiteCirclePositions = [];
let sliderValues = [];

function runCode() {
  originalCode = codeArea.value;
  preview.srcdoc = originalCode;
  panel.style.display = 'flex';
  panel.innerHTML = '<p><strong>Adjustable values appear after Run</strong></p>';
  whiteCirclePositions = [];
  sliderValues = [];

  const lines = originalCode.split('\n');
  lines.forEach((line, lineIndex) => {
    // Only check lines with white circles
    if (line.includes('class="white"')) {
      const regex = /(\d+\.?\d*)/g;
      let match;
      while ((match = regex.exec(line)) !== null) {
        whiteCirclePositions.push({
          lineIndex: lineIndex,
          startIndex: match.index,
          value: parseFloat(match[1])
        });
        sliderValues.push(parseFloat(match[1]));
      }
    }
  });

  // Create sliders for white circles only
  whiteCirclePositions.forEach((num, index) => {
    const div = document.createElement('div');
    div.className = 'control';

    const label = document.createElement('label');
    label.innerText = 'White Circle Line ' + (num.lineIndex + 1);

    const slider = document.createElement('input');
    slider.type = 'range';
    slider.min = 0;
    slider.max = 500;
    slider.value = sliderValues[index];

    slider.oninput = () => {
      sliderValues[index] = parseFloat(slider.value);
      updatePreview();
    };

    div.appendChild(label);
    div.appendChild(slider);
    panel.appendChild(div);
  });
}

function updatePreview() {
  let updatedCode = originalCode;
  let count = 0;
  // Replace only numbers inside white circles
  updatedCode = updatedCode.replace(/(\d+\.?\d*)/g, (match, p1, offset, string) => {
    // Check if this number corresponds to a white circle
    if (whiteCirclePositions[count] && string.includes('class="white"')) {
      const val = sliderValues[count];
      count++;
      return val;
    }
    return match;
  });
  preview.srcdoc = updatedCode;
}

function clearCode() {
  codeArea.value = '';
  updateLines();
  preview.srcdoc = '';
  panel.style.display = 'none';
  panel.innerHTML = '<p><strong>Adjustable values appear after Run</strong></p>';
  whiteCirclePositions = [];
  sliderValues = [];
}

function updateLines() {
  const code = codeArea.value;
  const lineNumbers = document.getElementById("lineNumbers");
  const lineCount = code.split("\n").length;
  lineNumbers.innerText = Array.from({length: lineCount}, (_, i) => i + 1).join("\n");
}

updateLines();
</script>
